$(function(){var F=$("#j-showUA"),m=$("#j-addUA"),w=$("#j-spoof"),x=$("#j-conf"),n=$("#j-filter"),y=$("#j-search"),p=$("#j-bd"),f=$("#j-uaForm"),g=$("#j-uaList"),G=$("#j-spoofBox"),q=$("#j-confBox"),r=$("#j-uaName"),s=$("#j-uaStr"),z=$("#j-uaFlag"),A=$("#j-uaGroup"),k=$("#j-spoofList"),B=$("#j-spoofForm"),t=$("#j-spoofUASel"),u=$("#j-domain"),H=$("#j-addUABtn"),I=$("#j-addSpoofBtn"),h=$("#j-uaListTmpl").val(),l=$("#j-spoofListTmpl").val(),J=$("#j-spoofUATmpl").val(),C="#options"==location.hash?!0:
!1;$UA=K.uaList();$SPOOF=K.spoofList();var D=function(){f.removeClass("show");m.hide();n.hide()},v=function(a){if(a=a.data("title"))n.hide(),$("#j-title").show().text(a)};g.html(K.tmpl(h,{list:$UA}));k.html(K.tmpl(l,$SPOOF));p.on("blur",".err",function(a){$(this).removeClass("err")});y.on("keyup",function(){var a=y.val().toLowerCase(),b={};$.each($UA,function(c,d){var e=b[c]={};$.each(d,function(b,c){e[b]=[];$.each(c,function(c,d){-1===d.slug.toLowerCase().indexOf(a)&&-1===d.title.toLowerCase().indexOf(a)&&
-1===d.ua.toLowerCase().indexOf(a)||e[b].push(d)})})});g.html(K.tmpl(h,{list:b,filter:a?!0:!1}))}).on("search",function(){g.html(K.tmpl(h,{list:$UA}))});p.on("click",".j-chgUA",function(){K.saveCurrUA($(this).data("index"));window.close();chrome.extension.sendRequest({action:"set"},function(a){console.log(a)})}).on("click",".j-groupAct",function(){var a=$(this).parents("li"),b=a.data("type"),c=a.find(".title").text(),d=$UA[b][c],e=[];$.confirm({text:'Delete: group "'+a.find(".title").text()+'" ?',
confirm:function(a){$.each(d,function(a,b){b&&b.readonly&&e.push(b)});e.length?$UA[b][c]=e:delete $UA[b][c];K.uaList($UA);g.html(K.tmpl(h,{list:$UA}))},cancel:function(a){}})}).on("click",".j-uaAct",function(){var a=$(this),b=a.parents("li"),c=a.data("action"),d=b.find(".j-chgUA").data("index"),d=d.split("::"),a=d[0],e=$UA.base[a]||$UA.custom[a];"del"==c?$.confirm({text:'Delete: user-agent "'+b.find(".ua-name").text()+'" ?',confirm:function(a){e.splice(d[1],1);K.uaList($UA);g.html(K.tmpl(h,{list:$UA}))},
cancel:function(a){}}):(b=e[d[1]],r.val(b.title),s.val(b.ua),z.val(b.slug),A.val(a),f.find(".j-saveType").val("mod").data({index:d[1],group:a}),f.addClass("show"),p.scrollTop(0))}).on("click",".j-spoofAct",function(){var a=$(this),b=a.data("action"),a=a.parents("li"),c=a.data("index");"del"==b?$.confirm({text:'Delete: domain "'+a.find(".ua-name").text()+'" ?',confirm:function(a){$SPOOF.splice(c,1);K.spoofList($SPOOF);k.html(K.tmpl(l,$SPOOF))},cancel:function(a){}}):(b=$SPOOF[c],u.val(b.domain),t.val(b.ua),
B.find(".j-saveType").val("mod").data("index",c))});H.click(function(a){a.preventDefault();var b=$(this).siblings(".j-saveType"),c=r.val(),d=s.val(),e=z.val();a=A.val()||"[No group]";if(!c)return r.addClass("err").focus();if(!d)return s.addClass("err").focus();$UA.custom||($UA.custom={});c={slug:e,title:c,ua:d};d=$UA.base[a]||$UA.custom[a]||($UA.custom[a]=[]);"mod"==b.val()?(e=b.data("index"),b=b.data("group"),a!==b?(($UA.base[b]||$UA.custom[b]).splice(e,1),d.push(c)):d[e]=c):d.push(c);K.uaList($UA);
g.html(K.tmpl(h,{list:$UA}));f.removeClass("show");f[0].reset()});I.click(function(a){a.preventDefault();a=$(this).siblings(".j-saveType");var b=u.val(),c=t.find("option:selected"),d=c.val(),c=c.data("slug");if(!b)return u.addClass("err").focus();b={slug:c,domain:b,ua:d};"mod"==a.val()?(a=a.data("index"),$SPOOF[a]=b):$SPOOF.push(b);K.spoofList($SPOOF);k.html(K.tmpl(l,$SPOOF));B[0].reset()});q.on("click",".j-backup",function(){var a={ua:$UA,spoof:$SPOOF},a=JSON.stringify(a);K.saveFileAs("UserAgentSwitcher+.bak",
btoa(a))}).on("change","#rfile",function(){var a=$("#rfile")[0];if(0<a.files.length&&0<a.files[0].name.length){var b=new FileReader;b.onload=function(a){a=atob(a.target.result);try{a=JSON.parse(a)}catch(b){}a.ua||alert("Error data format!");$UA=a.ua;K.uaList($UA);g.html(K.tmpl(h,{list:$UA}));a.spoof&&($SPOOF=a.spoof,K.spoofList($SPOOF),k.html(K.tmpl(l,$SPOOF)),$(".j-restore",q).after('<p class="r tip">Options restored successfully</p>'))};b.onerror=function(){};b.readAsText(a.files[0]);a.value=""}}).on("click",
".j-restore",function(){$("#rfile").click()}).on("click",".j-delAllspoof",function(){$.confirm({text:"Delete: all domains rules ?",confirm:function(a){K.local(SPOOFER_LIST,null);k.html(K.tmpl(l,null))}})}).on("click",".j-resetUA",function(){$.confirm({text:"Reset user-agent to default ?",confirm:function(a){K.local(CUSTOM_UA_LIST,null);$UA=K.uaList();g.html(K.tmpl(h,{list:$UA}))}})});F.click(function(){g.show().siblings("div").hide();f.removeClass("show");m.show();n.show()});m.click(function(){f.show().toggleClass("show");
p.scrollTop(0);if(!f.hasClass("show"))return n.show();f[0].reset();v(m)});w.click(function(){t.html(K.tmpl(J,$UA));G.show().siblings("div").hide();D();v(w)});var E=function(){q.show().siblings("div").hide();D();v(x)};x.click(function(){if(C)return E();chrome.tabs.create({url:"popup.html#options"})});C&&E()});
